--DAY 8 & 9
--1. FIND THE PLAYERS WITH THE HIGHEST OVA POT WITHIN EACH CLUB
-- First write a subquery that allows me to see all the highest, Using dense rank,I can see
-- all if there are more players ranking at number one
SELECT Club,OVA, POT, DENSE_RANK() OVER (PARTITION BY Club ORDER BY OVA DESC) AS TOP_RANKING
 FROM Fifa_21_RD1;

--QUERY
SELECT Name,Club,OVA,POT FROM
(SELECT Name, Club,OVA, POT, DENSE_RANK() OVER (PARTITION BY Club ORDER BY OVA DESC) AS TOP_RANKING
 FROM Fifa_21_RD1)
WHERE TOP_RANKING = 1
ORDER BY OVA DESC;
--2. CALCULATE THE AVERAGE OVA FOR PLAYERS UNDER 25YEARS AND OVER 30 YEARS OLD IN EACH CLUB
--Using case statement to specify each condition

SELECT Club,
       AVG(CASE
	      		 WHEN Age < 25 THEN OVA
	      		 ELSE NULL
	       END) AS Average_OVA_Under_25,
       AVG(CASE
	       		WHEN Age > 30 THEN OVA
	       		ELSE NULL
	       END) AS Average_OVA_Over_30
FROM Fifa_21_RD1
GROUP BY Club;

--3. LIST THE PLAYERS WHO HAVE THE SAME AGE WITHIN EACH CLUB
SELECT STRING_AGG(Name) AS PlayersWithSameAge,club , Age
FROM Fifa_21_RD1
GROUP BY Club, Age
HAVING COUNT(Age) > 1;


--4. FIND THE PLAYER WITH THE HIGHEST POT FOR EACH NATIONALITY
-- Write out Subquery
 SELECT Name, Nationality,POT, DENSE_RANK() OVER (PARTITION BY Nationality ORDER BY POT DESC) AS HIGHEST_POT
 FROM Fifa_21_RD1;

--query
SELECT Name,Nationality,POT FROM
(SELECT Name, Nationality,POT, DENSE_RANK() OVER (PARTITION BY Nationality ORDER BY POT DESC) AS HIGHEST_POT
 FROM Fifa_21_RD1)
WHERE HIGHEST_POT = 1
ORDER BY POT DESC;

--5. RANK PLAYERS BY THEIR OVA IN DESCENDING ORDER WITHIN CLUB
SELECT Name, Club, OVA, DENSE_RANK() OVER (PARTITION BY Club ORDER BY OVA DESC) AS Ranking
FROM Fifa_21_RD1;
